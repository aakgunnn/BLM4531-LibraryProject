<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kitap Düzenle - Kütüphane Sistemi</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="bi bi-book"></i> Kütüphane Sistemi
        </a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto" id="navMenu"></ul>
        </div>
      </div>
    </nav>

    <main class="py-5">
      <div class="container">
        <div class="row mb-4">
          <div class="col">
            <div class="d-flex align-items-center">
              <a href="/pages/catalog.html" class="btn btn-outline-primary me-3">
                <i class="bi bi-arrow-left"></i> Geri Dön
              </a>
              <div>
                <h2>
                  <i class="bi bi-pencil-square"></i> Kitap Düzenle
                </h2>
                <p class="text-muted mb-0">Kitap bilgilerini güncelleyin</p>
              </div>
            </div>
          </div>
        </div>

        <div id="alertContainer"></div>

        <div class="row">
          <div class="col-lg-8">
            <div class="card shadow-sm">
              <div class="card-body">
                <form id="editBookForm">
                  <div class="mb-3">
                    <label for="title" class="form-label">
                      <i class="bi bi-card-heading"></i> Kitap Başlığı
                      <span class="text-danger">*</span>
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="title"
                      required
                      maxlength="200"
                    />
                  </div>

                  <div class="mb-3">
                    <label for="author" class="form-label">
                      <i class="bi bi-person"></i> Yazar
                      <span class="text-danger">*</span>
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="author"
                      required
                      maxlength="100"
                    />
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="categoryId" class="form-label">
                        <i class="bi bi-tag"></i> Kategori
                        <span class="text-danger">*</span>
                      </label>
                      <select class="form-select" id="categoryId" required>
                        <option value="">Kategori seçin...</option>
                      </select>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label for="publishYear" class="form-label">
                        <i class="bi bi-calendar"></i> Yayın Yılı
                      </label>
                      <input
                        type="number"
                        class="form-control"
                        id="publishYear"
                        min="1000"
                        max="9999"
                      />
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="isbn" class="form-label">
                      <i class="bi bi-upc"></i> ISBN
                    </label>
                    <input
                      type="text"
                      class="form-control"
                      id="isbn"
                      maxlength="20"
                      placeholder="978-3-16-148410-0"
                    />
                  </div>

                  <div class="mb-3">
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="isAvailable"
                      />
                      <label class="form-check-label" for="isAvailable">
                        <i class="bi bi-check-circle"></i> Kitap müsait mi?
                      </label>
                    </div>
                    <small class="text-muted">
                      Bu seçenek kitabın şu anda ödünç alınabilir olup
                      olmadığını belirler
                    </small>
                  </div>

                  <hr class="my-4" />

                  <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg">
                      <i class="bi bi-save"></i> Değişiklikleri Kaydet
                    </button>
                    <a href="/pages/catalog.html" class="btn btn-outline-secondary">
                      <i class="bi bi-x-circle"></i> İptal
                    </a>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <!-- Kitap Kapağı -->
            <div class="card shadow-sm mb-3">
              <div class="card-header bg-warning text-dark">
                <i class="bi bi-image"></i> Kitap Kapağı
              </div>
              <div class="card-body">
                <div class="text-center mb-3">
                  <div
                    id="imagePreview"
                    style="
                      min-height: 300px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      background: #f8f9fa;
                      border-radius: 8px;
                      overflow: hidden;
                    "
                  >
                    <i
                      class="bi bi-image"
                      style="font-size: 4rem; color: #ccc"
                    ></i>
                  </div>
                </div>

                <div class="mb-3">
                  <label for="imageFile" class="form-label">
                    <i class="bi bi-upload"></i> Yeni Kapak Resmi Yükle
                  </label>
                  <input
                    type="file"
                    class="form-control"
                    id="imageFile"
                    accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                  />
                  <small class="text-muted">
                    Maksimum 5MB, JPG, PNG, GIF veya WebP formatında
                  </small>
                </div>

                <button
                  type="button"
                  class="btn btn-warning w-100"
                  id="uploadImageBtn"
                  disabled
                >
                  <i class="bi bi-cloud-upload"></i> Resmi Yükle
                </button>

                <input type="hidden" id="imageUrl" />
              </div>
            </div>

            <!-- Kitap Bilgileri -->
            <div class="card shadow-sm">
              <div class="card-header bg-info text-white">
                <i class="bi bi-info-circle"></i> Kitap Bilgileri
              </div>
              <div class="card-body">
                <p class="mb-2">
                  <strong>Kitap ID:</strong> <span id="bookIdDisplay">-</span>
                </p>
                <p class="mb-2">
                  <strong>Oluşturulma:</strong>
                  <span id="createdAtDisplay">-</span>
                </p>
                <p class="mb-0">
                  <strong>Son Güncelleme:</strong>
                  <span id="updatedAtDisplay">-</span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
      requireAuth();
      updateNavigation();

      // Admin kontrolü
      if (!isAdmin()) {
        showAlert(
          "danger",
          "Bu sayfaya erişim yetkiniz yok! Sadece adminler kitap düzenleyebilir."
        );
        setTimeout(() => {
          window.location.href = "/pages/catalog.html";
        }, 2000);
      }

      let bookId = null;
      let currentImageUrl = null;

      async function init() {
        // URL'den kitap ID'sini al
        const urlParams = new URLSearchParams(window.location.search);
        bookId = urlParams.get("id");

        if (!bookId) {
          showAlert("danger", "Kitap ID'si belirtilmedi!");
          setTimeout(() => {
            window.location.href = "/pages/catalog.html";
          }, 2000);
          return;
        }

        await loadCategories();
        await loadBookData();
      }

      async function loadCategories() {
        try {
          const response = await api.get("/api/Categories");
          const categories = response && response.data ? response.data : [];

          const categorySelect = document.getElementById("categoryId");
          if (Array.isArray(categories)) {
            categories.forEach((cat) => {
              categorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
            });
          }
        } catch (error) {
          console.error("Kategoriler yüklenemedi:", error);
          showAlert("danger", "Kategoriler yüklenemedi: " + error.message);
        }
      }

      async function loadBookData() {
        try {
          const response = await api.get(`/api/Books/${bookId}`);
          const book = response && response.data ? response.data : null;

          if (!book) {
            showAlert("danger", "Kitap bulunamadı!");
            return;
          }

          // Form alanlarını doldur
          document.getElementById("title").value = book.title || "";
          document.getElementById("author").value = book.author || "";
          document.getElementById("categoryId").value = book.categoryId || "";
          document.getElementById("publishYear").value = book.publishYear || "";
          document.getElementById("isbn").value = book.isbn || "";
          document.getElementById("isAvailable").checked = book.isAvailable;
          document.getElementById("imageUrl").value = book.imageUrl || "";

          // Bilgi kartını doldur
          document.getElementById("bookIdDisplay").textContent = book.id;
          document.getElementById("createdAtDisplay").textContent = new Date(
            book.createdAt || Date.now()
          ).toLocaleDateString("tr-TR");
          document.getElementById("updatedAtDisplay").textContent = new Date(
            book.updatedAt || Date.now()
          ).toLocaleDateString("tr-TR");

          // Mevcut kapak resmini göster
          currentImageUrl = book.imageUrl;
          if (book.imageUrl) {
            displayImage(book.imageUrl);
          }
        } catch (error) {
          console.error("Kitap yüklenemedi:", error);
          showAlert("danger", "Kitap yüklenemedi: " + error.message);
        }
      }

      function displayImage(url) {
        const preview = document.getElementById("imagePreview");
        preview.innerHTML = `<img src="${url}" class="img-fluid" alt="Kitap Kapağı" style="max-height: 300px; object-fit: cover; border-radius: 8px;" />`;
      }

      // Dosya seçildiğinde upload butonunu aktif et
      document.getElementById("imageFile").addEventListener("change", (e) => {
        const uploadBtn = document.getElementById("uploadImageBtn");
        uploadBtn.disabled = !e.target.files || e.target.files.length === 0;
      });

      // Resim yükleme
      document
        .getElementById("uploadImageBtn")
        .addEventListener("click", async () => {
          const fileInput = document.getElementById("imageFile");
          const file = fileInput.files[0];

          if (!file) {
            showAlert("warning", "Lütfen bir dosya seçin");
            return;
          }

          // Dosya boyutu kontrolü (5MB)
          if (file.size > 5 * 1024 * 1024) {
            showAlert("danger", "Dosya boyutu en fazla 5MB olabilir");
            return;
          }

          try {
            const uploadBtn = document.getElementById("uploadImageBtn");
            uploadBtn.disabled = true;
            uploadBtn.innerHTML =
              '<i class="bi bi-hourglass-split"></i> Yükleniyor...';

            const formData = new FormData();
            formData.append("file", file);

            const response = await api.upload("/api/Books/upload-image", formData);
            const imageUrl = response && response.data ? response.data : null;

            if (imageUrl) {
              document.getElementById("imageUrl").value = imageUrl;
              currentImageUrl = imageUrl;
              displayImage(imageUrl);
              showAlert("success", "Resim başarıyla yüklendi!");
              fileInput.value = "";
            }

            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Resmi Yükle';
          } catch (error) {
            console.error("Resim yükleme hatası:", error);
            showAlert("danger", "Resim yüklenemedi: " + error.message);
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Resmi Yükle';
          }
        });

      // Form submit
      document
        .getElementById("editBookForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const updateData = {
            title: document.getElementById("title").value.trim(),
            author: document.getElementById("author").value.trim(),
            categoryId: parseInt(document.getElementById("categoryId").value),
            publishYear: document.getElementById("publishYear").value
              ? parseInt(document.getElementById("publishYear").value)
              : null,
            isbn: document.getElementById("isbn").value.trim() || null,
            imageUrl: document.getElementById("imageUrl").value || null,
            isAvailable: document.getElementById("isAvailable").checked,
          };

          try {
            await api.put(`/api/Books/${bookId}`, updateData);
            showAlert("success", "Kitap başarıyla güncellendi!");
            setTimeout(() => {
              window.location.href = "/pages/catalog.html";
            }, 1500);
          } catch (error) {
            console.error("Kitap güncellenemedi:", error);
            showAlert("danger", "Kitap güncellenemedi: " + error.message);
          }
        });

      function showAlert(type, message) {
        const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        document.getElementById("alertContainer").innerHTML = alertHtml;
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      init();
    </script>
  </body>
</html>
